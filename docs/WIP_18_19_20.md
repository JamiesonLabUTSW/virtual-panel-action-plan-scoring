# WIP: Issues #18, #19, #20 — CopilotKit Integration Testing

## Status Summary

| Issue | Title                                     | Status                   |
| ----- | ----------------------------------------- | ------------------------ |
| #18   | Validate End-to-End Chat via Azure v1     | Done                     |
| #19   | Register a Test Agent with State Emission | Done                     |
| #20   | Validate Per-Session State Isolation      | Ready for manual testing |

---

## Architecture Change: Actions → Agents

**Key discovery:** `useCoAgent` on the frontend requires an `AbstractAgent` on the backend — it does
NOT work with CopilotKit actions. The plan originally used `actions: [testAction]` but this has been
migrated to `agents: { testAgent: new TestAgent() }` using a custom `AbstractAgent` subclass.

**What changed:**

- Backend: `server/src/actions/test-action.ts` → `server/src/agents/test-agent.ts` (AbstractAgent
  subclass)
- Backend: `CopilotRuntime({ actions: [...] })` → `CopilotRuntime({ agents: {...} })`
- Frontend: Direct fetch + manual SSE parsing → `useCoAgent<TestState>` + `useCoAgentStateRender`
- State emission: `context.emitStateUpdate()` → `Observable<BaseEvent>` with `STATE_SNAPSHOT` events
- Documentation: SPEC.md, CLAUDE.md, phase plans 02 and 04 all updated

---

## Issue #18: Validate End-to-End Chat via Azure v1

**Status: Done**

CopilotChat successfully round-trips messages through the full pipeline:

```
CopilotChat → CopilotKit Runtime → Azure OpenAI gpt-5.1-codex-mini → streaming response → CopilotChat
```

### Key discoveries & fixes

1. **Express mount point for CopilotKit**: Must use `app.use(handler)` at root, NOT
   `app.use("/api/copilotkit", handler)`. Express strips the mount prefix from `req.url`, but
   CopilotKit's internal Hono router reads `req.url` (not `req.originalUrl`) via `getFullUrl()`. The
   `endpoint` option in `copilotRuntimeNodeHttpEndpoint()` handles path matching internally.

2. **Vercel AI SDK env vars**: CopilotKit's auto-created `BuiltInAgent` uses the Vercel AI SDK
   internally, which expects standard OpenAI env vars. The `start-dev-server.sh` script bridges
   them:

   ```bash
   export OPENAI_API_KEY="${AZURE_OPENAI_API_KEY}"
   export OPENAI_BASE_URL="https://${AZURE_OPENAI_RESOURCE}.openai.azure.com/openai/v1/"
   ```

3. **Single POST endpoint**: CopilotKit v1.51 uses a single POST endpoint for all operations
   (`agent/run`, `agent/connect`, `info`). There is no separate GET `/info` endpoint — everything
   goes through `POST /api/copilotkit` with a `method` field in the JSON body.

4. **BuiltInAgent**: CopilotKit auto-creates a `BuiltInAgent` (from `@copilotkitnext/agent`) as the
   "default" agent when `handleServiceAdapter()` is called with a valid service adapter and no
   explicit agents are configured.

---

## Issue #19: Register a Test Agent with State Emission

**Status: Done**

### What was built

- `server/src/agents/test-agent.ts` — Custom `AbstractAgent` subclass with `run()` returning
  `Observable<BaseEvent>`
  - Emits: `RUN_STARTED` → `STATE_SNAPSHOT(step:0)` → 3x(`STEP_STARTED` → `STATE_SNAPSHOT(step:N)` →
    `STEP_FINISHED`) → `RUN_FINISHED`
  - 1-second delay per step (simulating judge work)
  - Cancellation support via Observable teardown
- `client/src/App.tsx` — `useCoAgent<TestState>` + `useCoAgentStateRender` + trigger button
  - Shows step counter, running status, and 3-circle progress indicator
  - In-chat state rendering via `useCoAgentStateRender`
- `server/src/__tests__/test-agent.test.ts` — 6 tests validating Observable event stream (all
  passing)
- `shared/types.ts` — `TestState` interface and `INITIAL_TEST_STATE` constant (unchanged from
  before)

### Key discoveries

1. **`AbstractAgent` requires `@ag-ui/client`** — imported alongside `EventType`, `BaseEvent`,
   `RunAgentInput`
2. **Dual `@ag-ui/client` packages** — CopilotKit bundles its own copy via `@copilotkitnext/shared`.
   Our explicit dep creates type conflicts. Fixed with `as any` cast on the `agents` record (same
   pattern as existing `OpenAIAdapter` and `copilotRuntimeNodeHttpEndpoint` casts).
3. **`STATE_SNAPSHOT` (not `STATE_DELTA`)** — full state replacement is simpler for small state
   objects. JSON Patch (`STATE_DELTA`) is unnecessary overhead for `{ step, message }`.
4. **Observable pattern** — wrapping async logic in
   `new Observable((subscriber) => { (async () => { ... })(); })` with cancellation flag.

---

## Issue #20: Validate Per-Session State Isolation

**Status: Ready for manual testing**

Session isolation is architecturally inherent:

- Each browser tab creates a unique `useCoAgent` connection with its own `threadId`
- `TestAgent.run()` creates a fresh Observable per request — no shared mutable state
- No process-wide singletons; state lives entirely within the Observable's async closure

### Manual test plan

1. `./start-dev-server.sh` + `npm run dev --workspace=@grading/client`
2. Open two browser tabs to `http://localhost:5173`
3. Trigger agent in Tab A → verify Tab B stays at step 0
4. Trigger agent in Tab B while A is running → verify independent progression
5. Verify in DevTools Network tab: each tab has its own SSE stream with independent `STATE_SNAPSHOT`
   events

---

## Files Modified/Created

| File                                      | Status    | Purpose                                                            |
| ----------------------------------------- | --------- | ------------------------------------------------------------------ |
| `server/src/index.ts`                     | Modified  | CopilotKit mounted at root, TestAgent registered via agents record |
| `client/src/App.tsx`                      | Modified  | useCoAgent + useCoAgentStateRender + TestAgentView                 |
| `server/src/agents/test-agent.ts`         | Created   | AbstractAgent subclass with Observable event stream                |
| `server/src/__tests__/test-agent.test.ts` | Created   | 6 unit tests for event stream (all passing)                        |
| `shared/types.ts`                         | Unchanged | TestState, INITIAL_TEST_STATE already present                      |
| `server/package.json`                     | Modified  | Added @ag-ui/client, rxjs as explicit deps                         |
| `SPEC.md`                                 | Modified  | §2, §5.1, §5.2: action→agent                                       |
| `CLAUDE.md`                               | Modified  | Architecture, flows, layout, agent registration section            |
| `docs/plan/02-copilotkit-spike.md`        | Modified  | §2.4: action→agent                                                 |
| `docs/plan/04-judge-pipeline.md`          | Modified  | §4.6: action→agent                                                 |
| `start-dev-server.sh`                     | Unchanged | Dev server launcher with env var bridging                          |
| `start-dev-client.sh`                     | Unchanged | Dev client launcher                                                |

### Files Deleted

| File                                       | Reason                                   |
| ------------------------------------------ | ---------------------------------------- |
| `server/src/actions/test-action.ts`        | Replaced by `agents/test-agent.ts`       |
| `server/src/actions/` (directory)          | Empty after deletion                     |
| `client/src/components/TestActionView.tsx` | Used removed `/api/test-action` endpoint |
| `client/src/components/` (directory)       | Empty after deletion                     |
| `server/src/__tests__/e2e-chat.test.ts`    | Tested old action handler                |

---

## Validation Results

```
Type-check:  PASS (all workspaces clean)
Lint:        PASS (8 pre-existing warnings, 0 errors)
Tests:       6/6 PASS (server/src/__tests__/test-agent.test.ts)
```

---

## Dev Workflow

```bash
# Terminal 1: Start server (loads .env + bridges OPENAI_* vars)
./start-dev-server.sh

# Terminal 2: Start client (Vite dev server with proxy to :7860)
./start-dev-client.sh

# Run tests
npm test --workspace=@grading/server
```
